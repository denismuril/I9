{% extends "base.html" %}
{% block title %}Gest√£o de Usu√°rios - Sistema I9{% endblock %}

{% block content %}
<header class="glass-effect bg-white/5 border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <a href="{{ url_for('main.dashboard') }}" class="text-blue-200 hover:text-white">‚Üê Dashboard</a>
            <span class="text-white font-bold">üë• Gest√£o de Usu√°rios</span>
        </div>
        <a href="{{ url_for('auth.logout') }}" class="px-4 py-2 bg-red-500/20 text-red-300 rounded-lg text-sm">Sair</a>
    </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-8">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div
        class="mb-4 p-3 rounded-lg text-sm {{ 'bg-green-500/20 text-green-200' if category == 'success' else 'bg-red-500/20 text-red-200' }}">
        {{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- Novo Usu√°rio -->
    <div class="glass-effect bg-white/10 rounded-2xl p-6 mb-8 border border-white/20">
        <h2 class="text-xl font-bold text-white mb-4">‚ûï Novo Usu√°rio</h2>
        <form action="{{ url_for('admin.criar_usuario') }}" method="POST">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <input type="text" name="nome" required placeholder="Nome"
                    class="px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200/50">
                <input type="email" name="email" required placeholder="Email"
                    class="px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200/50">
                <input type="password" name="senha" required placeholder="Senha"
                    class="px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200/50">
                <select name="role" id="novoUserRole" onchange="toggleFiliaisNovo()"
                    class="px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                    <option value="consultor" class="bg-slate-800">Consultor</option>
                    <option value="admin" class="bg-slate-800">Admin</option>
                </select>
            </div>
            <div id="filiaisNovoUser" class="mb-4">
                <label class="text-blue-200 text-sm mb-2 block">Filiais permitidas:</label>
                <div class="flex flex-wrap gap-3">
                    {% for f in filiais %}
                    <label class="flex items-center gap-2 text-white text-sm">
                        <input type="checkbox" name="filiais" value="{{ f.id }}" class="rounded">
                        {{ f.nome }}
                    </label>
                    {% endfor %}
                </div>
            </div>
            <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Criar
                Usu√°rio</button>
        </form>
    </div>

    <!-- Lista de Usu√°rios -->
    <div class="glass-effect bg-white/10 rounded-2xl p-6 border border-white/20">
        <h2 class="text-xl font-bold text-white mb-4">üìã Usu√°rios Cadastrados</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead>
                    <tr class="border-b border-white/10">
                        <th class="py-3 text-blue-200 text-sm">Nome</th>
                        <th class="py-3 text-blue-200 text-sm">Email</th>
                        <th class="py-3 text-blue-200 text-sm">Role</th>
                        <th class="py-3 text-blue-200 text-sm">Filiais</th>
                        <th class="py-3 text-blue-200 text-sm">Status</th>
                        <th class="py-3 text-blue-200 text-sm">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in usuarios %}
                    <tr class="border-b border-white/5">
                        <td class="py-3 text-white">{{ u.nome }}</td>
                        <td class="py-3 text-blue-200">{{ u.email }}</td>
                        <td class="py-3"><span
                                class="px-2 py-1 text-xs rounded {{ 'bg-purple-500/20 text-purple-300' if u.role == 'admin' else 'bg-blue-500/20 text-blue-300' }}">{{
                                u.role }}</span></td>
                        <td class="py-3 text-blue-200/70 text-sm">{{ u.filiais|map(attribute='nome')|join(', ') or '-'
                            }}</td>
                        <td class="py-3"><span
                                class="px-2 py-1 text-xs rounded {{ 'bg-green-500/20 text-green-300' if u.ativo else 'bg-red-500/20 text-red-300' }}">{{
                                'Ativo' if u.ativo else 'Inativo' }}</span></td>
                        <td class="py-3 flex gap-2">
                            <button
                                onclick="abrirModal({{ u.id }}, '{{ u.nome }}', '{{ u.email }}', '{{ u.role }}', {{ u.ativo|tojson }}, {{ u.filiais|map(attribute='id')|list|tojson }})"
                                class="text-blue-400 hover:text-blue-300 text-sm">Editar</button>
                            <form action="{{ url_for('admin.excluir_usuario', id=u.id) }}" method="POST" class="inline"
                                onsubmit="return confirm('Desativar este usu√°rio?')">
                                <button type="submit" class="text-red-400 hover:text-red-300 text-sm">Desativar</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</main>

<!-- Modal Editar Usu√°rio -->
<div id="modalEditar" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
    <div class="glass-effect bg-slate-800 rounded-2xl p-6 w-full max-w-lg border border-white/20 m-4">
        <h3 class="text-xl font-bold text-white mb-4">‚úèÔ∏è Editar Usu√°rio</h3>
        <form id="formEditar" method="POST">
            <div class="space-y-4">
                <div>
                    <label class="text-blue-200 text-sm">Nome</label>
                    <input type="text" name="nome" id="editNome" required
                        class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                </div>
                <div>
                    <label class="text-blue-200 text-sm">Email</label>
                    <input type="email" name="email" id="editEmail" required
                        class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                </div>
                <div>
                    <label class="text-blue-200 text-sm">Nova Senha (deixe vazio para manter)</label>
                    <input type="password" name="senha" id="editSenha"
                        class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div>
                    <label class="text-blue-200 text-sm">N√≠vel de Acesso</label>
                    <select name="role" id="editRole" onchange="toggleFiliaisEdit()"
                        class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                        <option value="consultor" class="bg-slate-800">Consultor</option>
                        <option value="admin" class="bg-slate-800">Admin</option>
                    </select>
                </div>
                <div id="filiaisEditContainer">
                    <label class="text-blue-200 text-sm mb-2 block">Filiais permitidas:</label>
                    <div class="flex flex-wrap gap-3">
                        {% for f in filiais %}
                        <label class="flex items-center gap-2 text-white text-sm">
                            <input type="checkbox" name="filiais" value="{{ f.id }}" class="filial-check rounded">
                            {{ f.nome }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" name="ativo" id="editAtivo" class="rounded">
                    <label for="editAtivo" class="text-white text-sm">Usu√°rio Ativo</label>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="submit"
                    class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar</button>
                <button type="button" onclick="fecharModal()"
                    class="flex-1 px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<script>
    function toggleFiliaisNovo() {
        const role = document.getElementById('novoUserRole').value;
        document.getElementById('filiaisNovoUser').style.display = role === 'consultor' ? 'block' : 'none';
    }

    function toggleFiliaisEdit() {
        const role = document.getElementById('editRole').value;
        document.getElementById('filiaisEditContainer').style.display = role === 'consultor' ? 'block' : 'none';
    }

    function abrirModal(id, nome, email, role, ativo, filiaisIds) {
        document.getElementById('formEditar').action = `/admin/usuarios/${id}/editar`;
        document.getElementById('editNome').value = nome;
        document.getElementById('editEmail').value = email;
        document.getElementById('editRole').value = role;
        document.getElementById('editAtivo').checked = ativo;
        document.getElementById('editSenha').value = '';

        // Limpa e marca filiais
        document.querySelectorAll('.filial-check').forEach(cb => {
            cb.checked = filiaisIds.includes(parseInt(cb.value));
        });

        toggleFiliaisEdit();
        document.getElementById('modalEditar').classList.remove('hidden');
        document.getElementById('modalEditar').classList.add('flex');
    }

    function fecharModal() {
        document.getElementById('modalEditar').classList.add('hidden');
        document.getElementById('modalEditar').classList.remove('flex');
    }
</script>
{% endblock %}